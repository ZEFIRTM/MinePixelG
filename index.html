<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Unity WebGL Player</title>
    <!-- Базовые скрипты -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="Build/TgWebGL.loader.js"></script>
    <!-- TON Connect скрипты -->
    <script>
        // Функция для загрузки скрипта с проверкой
        function loadScriptWithRetry(src, retries = 3) {
            return new Promise((resolve, reject) => {
                function attemptLoad(attemptsLeft) {
                    const script = document.createElement('script');
                    script.src = src;
                    script.async = false;
                    script.onload = resolve;
                    script.onerror = () => {
                        if (attemptsLeft > 0) {
                            setTimeout(() => attemptLoad(attemptsLeft - 1), 1000);
                        } else {
                            reject(new Error(`Failed to load script: ${src}`));
                        }
                    };
                    document.head.appendChild(script);
                }
                attemptLoad(retries);
            });
        }

        // Загружаем скрипты последовательно
        async function loadTonConnectScripts() {
            try {
                await loadScriptWithRetry('https://unpkg.com/@tonconnect/sdk@2.1.3/dist/tonconnect-sdk.min.js');
                await loadScriptWithRetry('https://unpkg.com/@tonconnect/ui@1.0.0/dist/tonconnect-ui.min.js');
                await loadScriptWithRetry('https://unpkg.com/tonweb@0.0.60/dist/tonweb.js');
                console.log('All TON Connect scripts loaded successfully');
            } catch (error) {
                console.error('Error loading TON Connect scripts:', error);
                throw error;
            }
        }

        // Загружаем скрипты сразу
        loadTonConnectScripts();
    </script>
    <style>
        body { 
            margin: 0; 
            padding: 0;
            overflow: hidden; 
            background-color: #000000; 
        }
        canvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        #gameContainer {
            width: 100vw;
            height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
        }
        #unity-canvas {
            width: 100%;
            height: 100%;
            background: #000000;
            display: block;
        }
        @media screen and (max-width: 1080px) {
            #unity-canvas {
                width: 100vw;
                height: 100vh;
            }
        }
        #loadingScreen {
            position: fixed;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: #000000;
            z-index: 9999;
            color: white;
            font-family: Arial, sans-serif;
        }
        #loadingScreen .loading-content {
            text-align: center;
        }
        #loadingScreen .loading-text {
            margin-top: 20px;
            font-size: 24px;
        }
        #loadingScreen .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        #loadingScreen .debug-info {
            margin-top: 20px;
            font-size: 14px;
            max-width: 80%;
            word-wrap: break-word;
            text-align: left;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #mobileInputField {
            position: absolute;
            top: -9999px;
            left: -9999px;
            z-index: -1;
            opacity: 0;
        }
        #connect-button {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        .ton-connect-ui {
            z-index: 1001 !important;
        }
    </style>
</head>
<body>
    <div id="loadingScreen">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading...</div>
            <div class="debug-info" id="debugInfo"></div>
        </div>
    </div>

    <div id="gameContainer">
        <canvas id="unity-canvas"></canvas>
    </div>
    <div id="connect-button"></div>
    <input id="mobileInputField" type="text" />

    <script>
        // Глобальные переменные
        window.TON_CONNECT_UI = null;
        window.tonConnectInitialized = false;
        window.telegramUserData = null;
        window.walletConnectionPromise = null;

        // Функция для отладки
        function addDebugInfo(text) {
            const debugDiv = document.getElementById('debugInfo');
            if (debugDiv) {
                const timestamp = new Date().toLocaleTimeString();
                debugDiv.innerHTML += `[${timestamp}] ${text}<br>`;
                console.log(`[${timestamp}] ${text}`);
            }
        }

        // Функция для проверки загрузки скриптов
        function checkTonConnectAvailability(maxAttempts = 10) {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const check = () => {
                    if (typeof TonConnectUI !== 'undefined') {
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        reject(new Error('TonConnectUI not available after maximum attempts'));
                    } else {
                        attempts++;
                        setTimeout(check, 500);
                    }
                };
                check();
            });
        }

        // Функция для инициализации TON Connect
        async function initializeTonConnect() {
            if (window.tonConnectInitialized) return;

            try {
                addDebugInfo('Waiting for TON Connect scripts...');
                await checkTonConnectAvailability();
                
                addDebugInfo('Initializing TON Connect...');
                window.TON_CONNECT_UI = new TonConnectUI({
                    manifestUrl: 'tonconnect-manifest.json',
                    buttonRootId: 'connect-button',
                    uiPreferences: {
                        theme: 'DARK'
                    }
                });

                window.TON_CONNECT_UI.onStatusChange(wallet => {
                    if (wallet) {
                        addDebugInfo('Wallet connected: ' + JSON.stringify(wallet));
                        if (window.unityInstance) {
                            window.unityInstance.SendMessage('TonConnectManager', 'HandleWalletConnected', JSON.stringify(wallet));
                        }
                    } else {
                        addDebugInfo('Wallet disconnected');
                        if (window.unityInstance) {
                            window.unityInstance.SendMessage('TonConnectManager', 'HandleWalletDisconnected', 'true');
                        }
                    }
                });

                window.tonConnectInitialized = true;
                addDebugInfo('TON Connect initialized successfully');

                if (window.unityInstance) {
                    window.unityInstance.SendMessage('TonConnectManager', 'HandleInitialization', 'true');
                }
            } catch (error) {
                addDebugInfo('Error initializing TON Connect: ' + error.message);
                if (error.stack) {
                    addDebugInfo('Error stack: ' + error.stack);
                }
                throw error;
            }
        }

        async function loadUnity() {
            addDebugInfo('Creating Unity instance...');
            
            try {
                const canvas = document.querySelector("#unity-canvas");
                const config = {
                    dataUrl: "Build/TgWebGL.data.unityweb",
                    frameworkUrl: "Build/TgWebGL.framework.js.unityweb",
                    codeUrl: "Build/TgWebGL.wasm.unityweb",
                    streamingAssetsUrl: "StreamingAssets",
                    companyName: "d4rk_ltd",
                    productName: "MinePixel",
                    productVersion: "0.1.0",
                    showBanner: (msg) => {
                        addDebugInfo('Unity banner: ' + msg);
                    }
                };

                window.unityInstance = await createUnityInstance(canvas, config);
                addDebugInfo('Unity initialized successfully');

                if (window.tonConnectInitialized) {
                    window.unityInstance.SendMessage('TonConnectManager', 'HandleInitialization', 'true');
                }
                
                document.getElementById("loadingScreen").style.display = 'none';
                
                setTelegramUserData();
                setInterval(checkTelegramData, 1000);
                
            } catch (error) {
                addDebugInfo('Unity initialization error: ' + error.message);
                if (error.stack) {
                    addDebugInfo('Error stack: ' + error.stack);
                }
            }
        }

        // Инициализация после загрузки страницы
        window.addEventListener('load', async function() {
            addDebugInfo('Page loaded, starting initialization...');
            try {
                await checkTonConnectAvailability();
                await initializeTonConnect();
                await loadUnity();
            } catch (error) {
                addDebugInfo('Initialization error: ' + error.message);
                if (error.stack) {
                    addDebugInfo('Error stack: ' + error.stack);
                }
            }
        });

        // Функция для подключения кошелька
        async function connectWallet() {
            try {
                if (!window.TON_CONNECT_UI) {
                    await initializeTonConnect();
                }
                
                window.walletConnectionPromise = window.TON_CONNECT_UI.connectWallet();
                const wallet = await window.walletConnectionPromise;
                return wallet;
            } catch (e) {
                console.error('Failed to connect wallet:', e);
                return null;
            }
        }

        // Функция для отключения кошелька
        async function disconnectWallet() {
            try {
                if (!window.TON_CONNECT_UI) {
                    console.error('TON Connect not initialized');
                    return false;
                }
                
                await window.TON_CONNECT_UI.disconnect();
                return true;
            } catch (e) {
                console.error('Failed to disconnect wallet:', e);
                return false;
            }
        }

        // Проверка доступности файлов
        async function checkFile(url) {
            try {
                const response = await fetch(url, { method: 'HEAD' });
                return response.ok;
            } catch (error) {
                return false;
            }
        }

        // Функция для получения и установки данных пользователя
        function setTelegramUserData() {
            if (window.Telegram && window.Telegram.WebApp) {
                const tg = window.Telegram.WebApp;

                // Получаем данные пользователя
                const user = tg.initDataUnsafe.user;
                addDebugInfo('Raw Telegram data: ' + JSON.stringify(tg.initDataUnsafe));

                if (user && user.id) {
                    // Сохраняем данные в глобальную переменную
                    window.telegramUserData = user;
                    addDebugInfo('User ID: ' + user.id);
                    addDebugInfo('Username: ' + (user.username || 'not set'));
                    addDebugInfo('First Name: ' + (user.first_name || 'not set'));

                    // Гарантируем, что все поля будут заполнены
                    const hash = '#' + [
                        `telegram_id=${user.id}`,
                        `username=${encodeURIComponent(user.username || user.first_name || 'unknown')}`,
                        `name=${encodeURIComponent(user.first_name || user.username || 'unknown')}`
                    ].join('&');

                    window.location.hash = hash;
                    addDebugInfo('Set hash: ' + hash);
                } else {
                    addDebugInfo('No valid user data found in Telegram WebApp');
                }

                tg.ready();
                tg.expand();
            } else {
                addDebugInfo('Telegram WebApp not initialized');
            }
        }

        // Функция для периодической проверки данных
        function checkTelegramData() {
            if (!window.location.hash.includes('telegram_id')) {
                setTelegramUserData();
            }
        }

        function focusMobileInputField() {
            const input = document.getElementById("mobileInputField");
            if (input) {
                input.style.position = "absolute";
                input.style.top = "50%";
                input.style.left = "50%";
                input.style.transform = "translate(-50%, -50%)";
                input.style.zIndex = "9999";
                input.style.opacity = "1";
                input.focus();
            }
        }

        function hideMobileInputField() {
            const input = document.getElementById("mobileInputField");
            if (input) {
                input.style.position = "absolute";
                input.style.top = "-9999px";
                input.style.left = "-9999px";
                input.style.zIndex = "-1";
                input.style.opacity = "0";
                input.blur();
            }
        }

        function getMobileInputValue() {
            const input = document.getElementById("mobileInputField");
            return input ? input.value : "";
        }

        function getTelegramUserData() {
            return window.telegramUserData ? JSON.stringify(window.telegramUserData) : null;
        }

        // Добавляем функции в глобальную область видимости
        window.connectWallet = connectWallet;
        window.disconnectWallet = disconnectWallet;
        window.focusMobileInputField = focusMobileInputField;
        window.hideMobileInputField = hideMobileInputField;
        window.getMobileInputValue = getMobileInputValue;
        window.getTelegramUserData = getTelegramUserData;
    </script>
</body>
</html>
