<!DOCTYPE html>

<html lang="en">

<head>

    <meta charset="UTF-8">

    <title>Unity WebGL Player</title>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <script src="https://unpkg.com/@tonconnect/sdk@latest/dist/tonconnect-sdk.min.js"></script>

    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>

    <script src="https://unpkg.com/tonweb@latest/dist/tonweb.js"></script>

    <script>

        // Глобальные переменные

        window.telegramUserData = null;

        window.TON_CONNECT_UI = null;

        window.walletConnectionPromise = null;



        // Инициализация TON Connect

        async function initTonConnect() {

            try {

                if (typeof TonConnectUI === 'undefined') {

                    console.error('TonConnectUI is not defined');

                    return false;

                }



                // Создаем глобальный объект для Unity

                window.TON_CONNECT_UI = new TonConnectUI({

                    manifestUrl: 'tonconnect-manifest.json',

                    buttonRootId: 'connect-button'

                });



                // Подписываемся на изменения состояния подключения

                window.TON_CONNECT_UI.onStatusChange(wallet => {

                    if (wallet) {

                        console.log('Wallet connected:', wallet);

                        if (window.unityInstance) {

                            window.unityInstance.SendMessage('TonConnectManager', 'HandleWalletConnected', JSON.stringify(wallet));

                        }

                    } else {

                        console.log('Wallet disconnected');

                        if (window.unityInstance) {

                            window.unityInstance.SendMessage('TonConnectManager', 'HandleWalletDisconnected', 'true');

                        }

                    }

                });



                return true;

            } catch (e) {

                console.error('Failed to initialize TON Connect:', e);

                return false;

            }

        }



        // Функция для подключения кошелька

        async function connectWallet() {

            try {

                if (!window.TON_CONNECT_UI) {

                    console.error('TON Connect not initialized');

                    return false;

                }

                

                window.walletConnectionPromise = window.TON_CONNECT_UI.connectWallet();

                const wallet = await window.walletConnectionPromise;

                return wallet;

            } catch (e) {

                console.error('Failed to connect wallet:', e);

                return null;

            }

        }



        // Функция для отключения кошелька

        async function disconnectWallet() {

            try {

                if (!window.TON_CONNECT_UI) {

                    console.error('TON Connect not initialized');

                    return false;

                }

                

                await window.TON_CONNECT_UI.disconnect();

                return true;

            } catch (e) {

                console.error('Failed to disconnect wallet:', e);

                return false;

            }

        }



        // Функция для отладки (данные будут видны до загрузки Unity)

        function addDebugInfo(text) {

            const debugDiv = document.getElementById('debugInfo');

            if (debugDiv) {

                debugDiv.innerHTML += text + '<br>';

            }

        }



        // Функция для получения и установки данных пользователя

        function setTelegramUserData() {

            if (window.Telegram && window.Telegram.WebApp) {

                const tg = window.Telegram.WebApp;



                // Получаем данные пользователя

                const user = tg.initDataUnsafe.user;

                addDebugInfo('Raw Telegram data: ' + JSON.stringify(tg.initDataUnsafe));



                if (user && user.id) {

                    // Сохраняем данные в глобальную переменную

                    window.telegramUserData = user;

                    addDebugInfo('User ID: ' + user.id);

                    addDebugInfo('Username: ' + (user.username || 'not set'));

                    addDebugInfo('First Name: ' + (user.first_name || 'not set'));



                    // Гарантируем, что все поля будут заполнены

                    const hash = '#' + [

                        `telegram_id=${user.id}`,

                        `username=${encodeURIComponent(user.username || user.first_name || 'unknown')}`,

                        `name=${encodeURIComponent(user.first_name || user.username || 'unknown')}`

                    ].join('&');



                    window.location.hash = hash;

                    addDebugInfo('Set hash: ' + hash);

                } else {

                    addDebugInfo('No valid user data found in Telegram WebApp');

                }



                tg.ready();

                tg.expand();

            } else {

                addDebugInfo('Telegram WebApp not initialized');

            }

        }



        // Функция для периодической проверки данных

        function checkTelegramData() {

            if (!window.location.hash.includes('telegram_id')) {

                setTelegramUserData();

            }

        }



        // Вызываем функцию несколько раз для надежности

        window.addEventListener('load', function() {

            // Создаем div для отладки

            const debugDiv = document.createElement('div');

            debugDiv.id = 'debugInfo';

            debugDiv.style.position = 'fixed';

            debugDiv.style.top = '10px';

            debugDiv.style.left = '10px';

            debugDiv.style.color = 'white';

            debugDiv.style.zIndex = '10000';

            debugDiv.style.backgroundColor = 'rgba(0,0,0,0.7)';

            debugDiv.style.padding = '10px';

            document.body.appendChild(debugDiv);



            addDebugInfo('Page loaded, initializing...');

            setTelegramUserData();



            // Проверяем каждую секунду в течение 10 секунд

            for (let i = 1; i <= 10; i++) {

                setTimeout(() => {

                    addDebugInfo('Attempt ' + i);

                    setTelegramUserData();

                }, i * 1000);

            }



            // Инициализация TON Connect будет происходить через Unity SDK

            if (window.unityInstance) {

                console.log("Unity instance ready for TON Connect integration");

            }

        });



        // Добавляем инициализацию TON Connect после загрузки Unity

        createUnityInstance(document.querySelector("#gameContainer"), {

            dataUrl: "Build/TgWebGL.data.unityweb",

            frameworkUrl: "Build/TgWebGL.framework.js.unityweb",

            codeUrl: "Build/TgWebGL.wasm.unityweb",

            streamingAssetsUrl: "StreamingAssets",

            companyName: "d4rk_ltd",

            productName: "MinePixel",

            productVersion: "0.1.0",

        }).then(async function(instance) {

            window.unityInstance = instance;

            document.getElementById("loadingScreen").style.display = 'none';

            document.getElementById('debugInfo').style.display = 'none';

            

            // Инициализируем TON Connect

            const initialized = await initTonConnect();

            if (initialized && window.unityInstance) {

                window.unityInstance.SendMessage('TonConnectManager', 'HandleInitialization', 'true');

            }

            

            setTelegramUserData();

            setInterval(checkTelegramData, 1000);

        }).catch(function(error) {

            console.error('Unity initialization error:', error);

            addDebugInfo('Unity initialization error: ' + error);

        });



        function focusMobileInputField() {

            const input = document.getElementById("mobileInputField");

            if (input) {

                input.style.position = "absolute";

                input.style.top = "50%";

                input.style.left = "50%";

                input.style.transform = "translate(-50%, -50%)";

                input.style.zIndex = "9999";

                input.style.opacity = "1";

                input.focus();

            }

        }



        function hideMobileInputField() {

            const input = document.getElementById("mobileInputField");

            if (input) {

                input.style.position = "absolute";

                input.style.top = "-9999px";

                input.style.left = "-9999px";

                input.style.zIndex = "-1";

                input.style.opacity = "0";

                input.blur();

            }

        }



        function getMobileInputValue() {

            const input = document.getElementById("mobileInputField");

            return input ? input.value : "";

        }



        function getTelegramUserData() {

            return window.telegramUserData ? JSON.stringify(window.telegramUserData) : null;

        }



        // Добавляем функции в глобальную область видимости

        window.connectWallet = connectWallet;

        window.disconnectWallet = disconnectWallet;

        window.focusMobileInputField = focusMobileInputField;

        window.hideMobileInputField = hideMobileInputField;

        window.getMobileInputValue = getMobileInputValue;

        window.getTelegramUserData = getTelegramUserData;

    </script>

    <style>

        body { 

            margin: 0; 

            overflow: hidden; 

            background-color: #000000; 

        }

        #loadingScreen {

            position: fixed;

            width: 100%;

            height: 100%;

            display: flex;

            justify-content: center;

            align-items: center;

            background-color: #000000;

            z-index: 9999;

        }

        #loadingScreen img {

            max-width: 200px;

            max-height: 200px;

        }

        #mobileInputField {

            position: absolute;

            top: -9999px;

            left: -9999px;

            z-index: -1;

            opacity: 0;

        }

    </style>

</head>

<body>

    <div id="loadingScreen">

        <img src="Assets/Textures/Other/MineCoin.png" alt="Loading...">

    </div>



    <div id="gameContainer" style="width: 100%; height: 100%;"></div>

    <div id="connect-button" style="display: none;"></div>



    <input id="mobileInputField" type="text" />



    <script src="Build/TgWebGL.loader.js"></script>

    <script src="ShowMobileKeyboard.js"></script>

</body>

</html>


